# 【JS】闭包


### 闭包的概念

如果一个函数访问了此函数的父级及父级以上的作用域变量，那么这个函数就是一个闭包。

本质上，JS中的每个函数都是一个闭包，因为每个函数都可以访问[全局变量]。

### 闭包的用途

1. 访问函数内部的变量
2. 让变量始终保持在内存中

### 闭包的优点

1. 可以减少全局变量的定义，避免全局变量的污染
2. 能够读取函数内部的变量
3. 在内存中维护一个变量，可以用做缓存

### 闭包的2种形成方式

#### 1、函数作为参数被传递

```js
// 将函数作为实参传递给另一个函数调用
function showDelay(msg,time){
    //setTimeout 的第一个参数function是函数，符合闭包的规则
    setTimeout(function(){
        alert(msg)
    },time)
}
showDelay('张三',2000)
```

#### 2、函数作为返回值被返回

```js
function a() {
    var i = '初始值';
    i = i + "—_执行a"
    // 此处的函数b访问了父级函数a中的局部变量i,成为了一个闭包
    function b() {
        i = i + "_执行b"
        console.log(i)
    }
    return b;
}
var c = a(); // 此时 i 的值为 ：初始值—_执行a
c()          // 此时 i 的值为 ：初始值—_执行a_执行b
c()          // 此时 i 的值为 ：初始值—_执行a_执行b_执行b
```

1. 将函数a赋值给全局变量c时，a会执行一次，局部变量 i 的值变为`初始值—_执行a`，最终返回函数b，此时全局变量c的值为闭包函数b的引用。

2. 此时函数a虽然已执行完，但因为内部包含闭包函数b，所以函数 a 的执行期上下文会继续保留在内存中，不会被销毁，所以局部变量 i 仍是`初始值—_执行a`

   {{< admonition type=abstract title="This is a tip" open=true >}}

   **执行期上下文**：当函数执行时，会创建一个执行期上下文的内部对象。每调用一次函数，就会创建一个新的上下文对象，他们之间是相互独立的。当函数执行完毕，它所产生的执行期上下文会被销毁

   {{< /admonition >}}

3. 第一次执行 `c()` 时，闭包函数b第一次执行，局部变量 i 的值变为`初始值—_执行a_执行b`

4. 第二次执行` c()` 时，闭包函数b第二次执行，局部变量 i 的值变为`初始值—_执行a_执行b_执行b`

### 闭包的特点

1. 被闭包函数访问的父级及以上的函数的局部变量（如范例中的局部变量 i ）会一直存在于内存中，不会被JS的垃圾回收机制回收。
2. 闭包函数实现了对其他函数内部变量的访问。（函数内部的变量对外是无法访问的，闭包通过这种变通的方法，实现了访问。）

{{< admonition type=abstract title="This is a tip" open=true >}}

**Javascript的垃圾回收机制**：

- 如果一个对象不再被引用，那么这个对象就会被GC回收。
- 如果两个对象互相引用，而不再被第三者所引用，那么这两个对象都会被回收。

{{< /admonition >}}

### 闭包的应用场景

模拟两人对话、使setTimeout支持传参、封装私有变量、模拟块作用域、实现迭代器



### 闭包的缺点

1. 造成内存泄露

   闭包会使函数中的变量一直保存在内存中，内存消耗很大，所以不能滥用闭包。

   【内存泄露：无用的变量一直在内存中，无法被释放】

   解决方法：使用完变量后，手动将它赋值为null；

   {{< admonition type=bug title="This is a tip" open=true >}}

   **闭包是内存泄漏吗?**

   闭包只是让变量在内存常驻，本身不是内存泄漏， 滥用闭包才会导致内存泄漏

   {{< /admonition >}}

2. 闭包可能在父函数外部，改变父函数内部变量的值。

3. 造成性能损失

   由于闭包涉及跨作用域的访问，所以会导致性能损失。

   解决方法：通过把跨作用域变量存储在局部变量中，然后直接访问局部变量，来减轻对执行速度的影响



{{< admonition type=warning title="免责申明" open=true >}}

————————————————

转载摘录，原文链接：https://blog.csdn.net/weixin_41192489/article/details/124312822

本文仅用于记录学习，不做商用，版权归属原作者，如涉侵权，请联系删除

{{< /admonition >}}

